package net.sf.webcat.reporter;
// Generated by the WOLips Templateengine Plug-in at Jan 30, 2007 1:48:08 PM

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.Enumeration;

import net.sf.webcat.core.WCComponent;
import net.sf.webcat.grader.PickStepPage;
import net.sf.webcat.reporter.datamodel.IResultSet;

import com.webobjects.appserver.*;
import com.webobjects.eocontrol.EOFetchSpecification;
import com.webobjects.eocontrol.EOQualifier;
import com.webobjects.foundation.NSArray;
import com.webobjects.foundation.NSKeyValueCodingAdditions;
import com.webobjects.foundation.NSMutableArray;
import com.webobjects.foundation.NSMutableDictionary;

public class ViewReportsPage extends WCComponent {

	public String binding1, keyPath1, where1;
	public String binding2, keyPath2, where2;
	public String binding3, keyPath3, where3;
	public String binding4, keyPath4, where4;
	public String column1, column2, column3, column4;
	public String error;
	public String queryString;
	public long qualifierElapsed, manualElapsed;

    public NSMutableArray resultSetRows;
    public NSMutableArray resultSetRow;
    public String resultSetColumn;
    public int index;

    public ViewReportsPage(WOContext context) {
        super(context);
    }
    
    public void appendToResponse(WOResponse response, WOContext context)
    {
    	if(queryString != null && queryString.length() > 0)
    	{
        	NSMutableDictionary initialBindings = new NSMutableDictionary();
        	initialBindings.setObjectForKey(wcSession().user(), "user");

    		resultSetRows = new NSMutableArray();

    		try
    		{
            	IResultSet results = Reporter.getInstance().executeReporterQuery(
            			queryString, initialBindings);
            	
		    	while(results.hasRow())
		    	{
		    		NSMutableArray row = new NSMutableArray();
		    		
		    		if(column1 != null)
		    		{
		    			String str = results.stringValue(column1);
		    			if(results.wasNull())
		    				str = "<null>";

		    			row.addObject(str);
		    		}
		    		
		    		if(column2 != null)
		    		{
		    			String str = results.stringValue(column2);
		    			if(results.wasNull())
		    				str = "<null>";

		    			row.addObject(str);
		    		}
		    		
		    		if(column3 != null)
		    		{
		    			String str = results.stringValue(column3);
		    			if(results.wasNull())
		    				str = "<null>";

		    			row.addObject(str);
		    		}
		    		
		    		if(column4 != null)
		    		{
		    			String str = results.stringValue(column4);
		    			if(results.wasNull())
		    				str = "<null>";

		    			row.addObject(str);
		    		}
		    		
		    		resultSetRows.addObject(row);
		    		results.moveToNextRow();
		    	}
		    	
		    	error = null;
    		}
    		catch(Exception e)
    		{
    			StringWriter sw = new StringWriter();
    			PrintWriter pw = new PrintWriter(sw);
    			e.printStackTrace(pw);
    			pw.flush();
    			error = sw.toString();
    		}
	    }

    	super.appendToResponse(response, context);
    }

    public void awake()
    {
    	resultSetRows = new NSMutableArray();
    	
    	queryString = "for course in CourseOffering whose crn == '91518';\n" +
    		"let c = course;\n" +
    		"for assn in AssignmentOffering whose courseOffering == #c;\n" +
    		"let a = assn.assignment;\n" +
    		"let an = a.name;\n" +
    		"let cn = c.crn;\n";

    	column1 = "cn";
		column2 = "an";
    	error = null;
    }

    public WOComponent executeQuery()
    {
        return null;
    }
}